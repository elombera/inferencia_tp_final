---
title: "Analisis del ruido ambiental de la CABA durante navidad y año nuevo"
author: "Joaquin Cerviño, Dario Ruiz y Esteban Lombera"
date: "8/29/2021"
output:
  html_document:
    code_folding: show
    df_print: paged
    theme: united
    highlight: pygments
    toc: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(magrittr)
library(purrr)
library(dplyr)
library(seewave)
library(nlme)
library(car)
library(lme4)
library(sp)
library(leaflet)
library(htmltools)
```

<style>
  body {
    text-align: justify
  }
</style>

## Introducción y descripción de datos
El presente trabajo pretende analizar como varia el nivel de ruido ambiental en la Ciudad Autónoma de Buenos Aires (CABA) durante las fechas festivas (específicamente navidad, y año nuevo). Para ello, se realizaron medidas experimentales de ruido en ambos dias festivos en 7 puntos (*n = 7*) de la CABA según su normativa vigente *([link](https://www.argentina.gob.ar/normativa/provincial/ley-1540-123456789-0abc-defg-045-1000xvorpyel))*. Por otro lado, se cuenta con medidas control de ruido en 7 puntos (*n = 7*) de la CABA provistas por la Agencia de Protección Ambiental (APrA) del Gobierno de la ciudad. Estas medidas control fueron obtenidas durante días de semana en periodos de actividad normal. La APrA cuanta con más de 400 puntos de medida distribuidos por toda la ciudad, Los 7 puntos control fueron seleccionados con el criterio de mayor proximidad a los puntos experimentales.
La figura 1 muestra la distribución de los puntos de medida. En rojo los puntos experimentales y en azul los puntos control. Al hacer click en cada punto se puede visualizar su detalle.

```{r fig-margin0, fig.margin=TRUE, fig.dim = c(9, 4), fig.align='center'}
mapa.puntos = read.csv("./data/puntosEs.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)
lat = char2dms(as.character(mapa.puntos$Latitud), chd="°",chm="\'",chs="\"")
mapa.puntos$lat <- c(as.numeric(lat))
lng =  char2dms(as.character(mapa.puntos$Longitud), chd="°",chm="\'",chs="\"")
mapa.puntos$lng <- c(as.numeric(lng))
mapa.puntos %<>% mutate(
  lat = case_when(
    lat < 0 ~ lat,
    lat > 0 ~ lat * -1
  )
)
beatCol <- colorFactor(palette = c("blue","red"), mapa.puntos$Fecha)
labelPunto <- paste(sep=" ",'Punto', mapa.puntos$Posicion , mapa.puntos$Barrio...Comuna)
map <- leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = mapa.puntos, lat = ~lat, lng = ~lng,
                   color = ~beatCol(Fecha),
                   label = labelPunto)%>%
  addLegend("bottomright", pal = beatCol, values = mapa.puntos$Fecha,
            title = "Puntos de medida",
            opacity = .5)
map

```
<br />
<style>
body {
text-align: justify}
</style>
Cada sonómetro utilizado realizó mediciones de nivel de presión sonora en dBA cada 1 segundo a lo largo de 2 horas. Desde las 23:00hs hasta las 01:00hs. Las fechas de medición fueron iniciadas los días 24/12/2020 (Navidad) y 31/12/2020 (Año nuevo); y finalizadas los días 25/12/2020 y 1/1/2021 respectivamente. Los datos otorgados por la APrA corresponden a el Nivel Continuo Equivalente ponderado A medido entre las 23:00hs hasta las 01:00hs durante días no feriados de actividad normal (se descartan días durante vacaciones de invierno y verano).
La tabla 1 muestra los datos obtenidos del nivel sonoro (dBA) por segundo para cada punto de medida en ambas fechas festivas. La tabla 2, presenta los datos provistos por la APrA del nivel continuo equivalente entre las 23:00 y las 01:00 para cada dia medido. 
<br />
Tabla 1
```{r rows.print=6,message=FALSE, warning=FALSE}
tabla.datos = read.csv("./data/datosR.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)
tabla.datos %<>% mutate(fecha = case_when(
  fecha != 'Navidad' ~ 'Año_nuevo',
  fecha == 'Navidad' ~ 'Navidad',
))
tabla.datos
```
Tabla 2
```{r rows.print=6,message=FALSE, warning=FALSE}
tabla.datosAPRA = read.csv("./data/datosAPrA.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)
tabla.datosAPRA
```
<br />
<style>
body {
text-align: justify}
</style>
La figura 2 muestra gráficamente los niveles de presión sonora en dBA a lo largo de los 7200 segundo (1 datos por segundo durante 2 horas) por cada punto de medida para las dos fechas (Navidad y Año nuevo)
```{r fig-margin2, fig.margin=TRUE, fig.dim = c(10, 6), fig.align="center"}
figura1 = ggplot(tabla.datos, aes(x=tiempo, y=nivel_sonoro))+
          geom_point(alpha = 0.3)+
          facet_grid(fecha~punto)+
          theme_pubr(base_size = 12, margin = TRUE)+
          scale_x_continuous(name= "Tiempo [seg]", breaks=c(0,3500,7000), labels=c("0","3k5","7k")) +
          labs(y = "Nivel de presión [dBA]") +
          theme(legend.position = "top",
                legend.title = element_blank())
figura1

```

## Hipótesis de trabajo

Pretendemos analizar estos datos a fin de responder las siguientes hipótesis:

H1: El nivel de ruido ambiental en la CABA es significativamente mayor durante los festejos de navidad y año nuevo

H2: El nivel de ruido ambiental en la CABA durante los festejos de año nuevo es significativamente mayor que durante navidad

## Manipulación de datos
Con el fin de diferenciar el nivel de ruido ambiental cuando hay pirotecnia y cuando no, se agrega una columna “condición” donde se describe aquellos puntos “sin pirotecnia” entre las 23:00 hs hasta las 00:00 hs y aquellos puntos “con pirotecnia” entre las 00:00 hs hasta las 01:00 hs.
Para la tabla 2 (puntos provistos por la APrA), se calcula una media y un sd para cada punto.



```{r eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
tabla.datos <- tabla.datos %>%
  mutate(condicion = case_when(
    tiempo <= 3600 ~ 'sin_pirotecnia',
    tiempo > 3600 ~ 'con_pirotecnia',
  ))

tabla.datosAPRA.promedio <- tabla.datosAPRA %>%
  group_by(punto) %>%
  summarise(nivel_sonoro_mean = mean(LeqA),
            nivel_sonoro_sd = sd(LeqA))
tabla.datosAPRA.promedio$condicion = "Control"
tabla.datosAPRA.promedio$fecha = "Navidad"
tabla.datosAPRA.promedio2 = tabla.datosAPRA.promedio
tabla.datosAPRA.promedio2$fecha = "Año_nuevo"

tabla.datos.promedio <- tabla.datos %>%
  group_by(fecha,condicion,punto) %>%
  summarise(nivel_sonoro_mean = meandB(nivel_sonoro),
            nivel_sonoro_sd = sddB(nivel_sonoro))
idx = merge(x = tabla.datosAPRA.promedio, y =  tabla.datosAPRA.promedio2, all = TRUE)
tabla.h1 = merge(x = tabla.datos.promedio, y =  idx, all = TRUE)
```

## Resultados

```{r eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE}
fig = ggplot(tabla.datos.promedio, aes(x = condicion, y = nivel_sonoro_mean, color = condicion))+
      geom_jitter(width = 0.1, alpha = 1)+
      # geom_boxplot()+
    stat_summary(fun.data = "mean_se",
               geom = "bar",
               alpha = .1,
               position = position_dodge(width = 1)) +
  stat_summary(fun.data = "mean_se",
               geom = "linerange",
               size=2,
               position = position_dodge(width = 1)) +
      facet_grid(fecha~.)+
      theme_pubr(base_size = 12, margin = TRUE)+
      labs(y = "Nivel de presión [dBA]", x = "Condicion") +
      theme(legend.position = "top",
            legend.title = element_blank())
fig


fig2 = ggplot(tabla.h1, aes(x = condicion, y = nivel_sonoro_mean, color = condicion))+
      geom_jitter(width = 0.1, alpha = 1)+
      # geom_boxplot()+
    stat_summary(fun.data = "mean_se",
               geom = "bar",
               alpha = .1,
               position = position_dodge(width = 1)) +
  stat_summary(fun.data = "mean_se",
               geom = "linerange",
               size=2,
               position = position_dodge(width = 1)) +
      facet_grid(fecha~.)+
      theme_pubr(base_size = 12, margin = TRUE)+
      labs(y = "Nivel de presión [dBA]", x = "Condicion") +
      theme(legend.position = "top",
            legend.title = element_blank())
fig2
```


### Análisis mediante modelo de efectos mixtos
<style>
body {
text-align: justify}
</style>
Para analizar los datos de SPL durante navidad y año nuevo, se consideró necesaria la adopción de un modelo de efectos mixtos.
Las medidas de nivel de presión sonoro del ruido ambiente fueron tomadas en locaciones geográficas específicas repetidas para las dos fechas. Consecuentemente, se considera a éstas como unidades de análisis, y por lo tanto factores aleatorios.
Por otro lado, las fechas(Navidad y año nuevo) y la condición (con o sin pirotecnia, es decir, antes o después de las 00:00 horas) son consideradas como efectos fijos.
El tiempo se consideró como la variable independiente a partir de la cual generar la regresión lineal.
<style>
.html-widget {
    margin: auto;
}
</style>
```{r fig-margin111, fig.margin=TRUE, fig.dim = c(9, 4)}
tabla.datos = read.csv("./data/datosR.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)

# tengo un problema de encoding con la ñ de columna Año Nuevo
tabla.datos %<>% mutate(fecha = case_when(
  fecha != 'Navidad' ~ 'Anio_nuevo',
  fecha == 'Navidad' ~ 'Navidad',
))

tabla.datos %<>%
  mutate(condicion = case_when(
    tiempo <= 3600 ~ 'sin_pirotecnia',
    tiempo > 3600 ~ 'con_pirotecnia',
  ))

pirotecnia.lme <- lme(nivel_sonoro ~ fecha*condicion*tiempo, data = tabla.datos, random = ~ 1|punto)

summary(pirotecnia.lme)

```
<br />
<style>
body {
text-align: justify}
</style>
### Anova del modelo
Al realizar un Anova del modelo se puede observar que existen diferencias significativas para fecha y condición. Por lo tanto, se puede inferir que existen diferencias significativas entre el nivel de ruido ambiente durante navidad y año nuevo. También, se hace notoria la diferencia significativa existente para las condiciones con y sin pirotecnia, esto es, antes y después de las 00:00 horas.

Por otro lado, es observable una interacción entre fecha y condición. Consecuentemente, se puede afirmar que la difrencia de nivel de ruido ambiente para las dos condiciones, con y sin pirotecnia, es significativamente diferente durante navidad y año nuevo.
<br />
```{r echo=TRUE,fig-margin222}
Anova(pirotecnia.lme)

```
<br />
<style>
body {
text-align: justify}
</style>
### Residuos
A continuación se grafican los residuos que genera nuestro modelo para cada uno de los efectos aleatorios, estos son, los distintos puntos donde se tomaron las medidas de presión sonora, considerados unidad de análisis.
<br />
```{r fig-margin3333, fig.margin=TRUE, fig.dim = c(9, 4)}
residuo_datos2 <- tabla.datos %>% mutate(res = resid(pirotecnia.lme )) %>% tibble()
p3 = ggplot(residuo_datos2, aes(x = res, y = tabla.datos$punto)) + geom_boxplot()
p3

```

<br />
<style>
body {
text-align: justify}
</style>
Para ilustrar el modelo obtenido, se procede a diagramarlo junto con las medidas tomadas de presión sonora.
<br />
```{r fig-margin4444, fig.margin=TRUE, fig.dim = c(9, 4)}

data_m1.lm <- tabla.datos %>% mutate(pred = predict(pirotecnia.lme), res = resid(pirotecnia.lme))

figura2 = ggplot(tabla.datos, aes(x=tiempo, y=nivel_sonoro))+
  geom_point(alpha = 0.3)+
  facet_grid(fecha~punto)+
  theme_pubr(base_size = 12, margin = TRUE)+
  scale_x_continuous(name= "Tiempo [seg]", breaks=c(0,3500,7000), labels=c("0","3k5","7k")) +
  labs(y = "Nivel de presión [dBA]") +
  theme(legend.position = "top",
        legend.title = element_blank())+
  geom_line(data=data_m1.lm, aes(x=tiempo, y=pred, group=punto), color='white')

figura2
```

### Prueba T


## Discusion - Conclusion

Debug

```{r eval=TRUE, echo=TRUE}
# mapa.puntos = read.csv("./data/puntosE.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)
# lat = char2dms(as.character(mapa.puntos$Latitud), chd="°",chm="\'",chs="\"")
# mapa.puntos$lat <- c(as.numeric(lat))
# lng =  char2dms(as.character(mapa.puntos$Longitud), chd="°",chm="\'",chs="\"")
# mapa.puntos$lng <- c(as.numeric(lng))
# mapa.puntos$lat <- jitter(mapa.puntos$lat, factor = 1)
# mapa.puntos$lng <- jitter(mapa.puntos$lng, factor = 1)
# mapa.puntos %<>% mutate(
#   lat = case_when(
#     lat < 0 ~ lat,
#     lat > 0 ~ lat * -1
#   )
# )
# beatCol <- colorFactor(palette = c("red","blue","green"), mapa.puntos$Fecha)
# map <- leaflet() %>%
#   addTiles() %>%
#   addCircleMarkers(data = mapa.puntos, lat = ~lat, lng = ~lng,
#                    popup = mapa.puntos$Barrio...Comuna,
#                    color = ~beatCol(Fecha))%>%
#  addLegend("bottomright", pal = beatCol, values = mapa.puntos$Fecha,
#             title = "Puntos de medida",
#             opacity = .5)
#   # addMarkers(lng = mapa.puntos$lng, lat= mapa.puntos$lat,
#   #            popup = mapa.puntos$Barrio...Comuna,
#   #            color_palette("Dark"))
# map

  

```

