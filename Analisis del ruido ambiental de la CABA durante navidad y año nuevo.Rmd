---
title: "Analisis del ruido ambiental de la CABA durante navidad y año nuevo"
author: "Joaquin Cerviño, Dario Ruiz y Esteban Lombera"
date: "8/29/2021"
output:
  html_document:
    code_folding: show
    df_print: paged
    theme: united
    highlight: pygments
    toc: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(magrittr)
library(purrr)
library(dplyr)
library(seewave)
library(nlme)
```

## Introducción y descripción de datos
El presente trabajo pretende analizar como varia el nivel de ruido ambiental en la Ciudad Autónoma de Buenos Aires (CABA) durante las fechas festivas (específicamente navidad y año nuevo). Para ello, se realizaron medidas de ruido en 7 puntos (n = 7) de la CABA según su normativa vigente ([link](https://www.argentina.gob.ar/normativa/provincial/ley-1540-123456789-0abc-defg-045-1000xvorpyel)). La figura XXX muestra la distribucion de los puntos de medida.

<div>
<p style = 'text-align:center;'>
<img src="https://raw.githubusercontent.com/elombera/inferencia_tp_final/main/data/mapa.png" width="300px">
</p>
</div>

Cada sonómetro realizo mediciones de nivel de presión sonora en dBA cada 1 segundo a lo largo de 2 horas. Desde las 23:00hs hasta las 01:00hs. Las fechas de medición fueron iniciadas los días 24/12/2020 (Navidad) y 31/12/2020 (Año nuevo); y finalizadas los días 25/12/2020 y 1/1/2021 respectivamente.

La tabla XXX muestra los datos obtenidos.
```{r rows.print=6,message=FALSE, warning=FALSE}
tabla.datos = read.csv("./data/datosR.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)
tabla.datos
tabla.datosAPRA = read.csv("./data/datosRAPRAFINAL2.csv", header = TRUE, sep = ';', stringsAsFactors = TRUE)
tabla.datosAPRA

```
La figura XXX muestra gráficamente los niveles de presión sonora en dBA a lo largo de los 7200 segundo (1 datos por segundo durante 2 horas) por cada punto de medida para las dos fechas (Navidad y Año nuevo)

```{r fig-margin2, fig.margin=TRUE, fig.dim = c(10, 6), fig.align="center"}
figura1 = ggplot(tabla.datos, aes(x=tiempo, y=nivel_sonoro))+
          geom_point(alpha = 0.3)+
          facet_grid(fecha~punto)+
          theme_pubr(base_size = 12, margin = TRUE)+
          scale_x_continuous(name= "Tiempo [seg]", breaks=c(0,3500,7000), labels=c("0","3k5","7k")) +
          labs(y = "Nivel de presión [dBA]") +
          theme(legend.position = "top",
                legend.title = element_blank())
figura1

```

## Hipótesis de trabajo

Pretendemos analizar estos datos a fin de responder las siguientes hipótesis:

H1: El nivel de ruido ambiental en la CABA es significativamente mayor durante los festejos de navidad y año nuevo

H2: El nivel de ruido ambiental en la CABA durante los festejos de año nuevo es significativamente mayor que durante navidad

## Manipulación de datos
 - Agregar a la tabla una fila que sea "condicion" que sea "con pirotecnia" cuando el tiempo es mayor a 3600 y "sin pirotecnia" cuando es menor o igual a 3600. Usar mutate --- 

```{r eval=TRUE, echo=TRUE}
tabla.datos <- tabla.datos %>%
  mutate(condicion = case_when(
    tiempo <= 3600 ~ 'sin_pirotecnia',
    tiempo > 3600 ~ 'con_pirotecnia',
  ))


tabla.datos.promedio <- tabla.datos %>%
  group_by(fecha,condicion) %>%
  summarise(nivel_sonoro_mean = meandB(nivel_sonoro, level = "IL"),
            nivel_sonoro_sd = sddB(nivel_sonoro, level = "IL"))

tabla.datos.promedioMAL <- tabla.datos %>%
  group_by(fecha,condicion) %>%
  summarise(nivel_sonoro_mean = mean(nivel_sonoro),
            nivel_sonoro_sd = sd(nivel_sonoro))


fig = ggplot(tabla.datos, aes(x = condicion, y = nivel_sonoro, color = condicion))+
      geom_jitter(width = 0.1, alpha = 0.1)+
      geom_boxplot()+
      facet_grid(fecha~.)+
      theme_pubr(base_size = 12, margin = TRUE)+
      labs(y = "Nivel de presión [dBA]", x = "Condicion") +
      theme(legend.position = "top",
            legend.title = element_blank())
fig

```


## Análisis estadistico
```{r Estadisitca eval=TRUE, echo=TRUE}
modelo1 = lm(nivel_sonoro ~ fecha*condicion, 
             data = tabla.datos)

# nivel_sonoro = 55.15567 + 0.99329 "Navidad" -7.45520 "Sin pirotecnia" + 2.60660 "Navidad*Sin_pirotecnia
summary(modelo1)
library(car)
Anova(modelo1, type = 3)
```


## Resultados

## Conclusión

Debug

```{r debug eval=TRUE, echo=TRUE}

# tabla.datos.promedio4 <- tabla.datos %>%
#   group_by(fecha,condicion) %>%
#   summarise(nivel_sonoro_mean = meandB(nivel_sonoro),
#             nivel_sonoro_sd = sddB(nivel_sonoro))
# 
# tabla.datos.promedio3 <- tabla.datos %>%
#   group_by(fecha,condicion) %>%
#   summarise(nivel_sonoro_mean = 10*log10(sum(10^(nivel_sonoro/10))/n()),
#             nivel_sonoro_sd = sd(10*log10(sum(10^(nivel_sonoro/10))/n())))
# 
# 
# 
# datos  %<>%  mutate(intervalo_min = case_when(
#       tiempo <= 900 ~  15,
#       tiempo <= 1800 ~ 30,
#       tiempo <= 2700 ~ 45,
#       tiempo <= 3600 ~ 60,
#       tiempo <= 4500 ~ 75,
#       tiempo <= 5400 ~ 90,
#       tiempo <= 6300 ~ 105,
#       tiempo <= 7200 ~ 120,
#     ))
# 
# intervalo_spl <- datos %>%
#   group_by(punto,fecha,intervalo_min,condicion) %>%
#   summarise(nivel_sonoro_avg = 10*log10(sum(10^(nivel_sonoro/10))/n()))
# 
# figura_navidad_spl_avg = intervalo_spl %>%
#   filter(fecha=='Navidad') %>%
#   ggplot( aes(x=intervalo_min,y=nivel_sonoro_avg)) +
#   geom_line()+
#   facet_wrap(punto~.)+
#   labs(x = "Intervalos de 15 minutos",
#        y = "SPL",
#        title = "SPL promedio cada 15 minutos para Navidad") +
#   theme_minimal()
# 
# figura_navidad_spl_avg
# 
# figura_anio_nuevo_spl_avg = intervalo_spl %>%
#   filter(fecha!='Navidad') %>%
#   ggplot( aes(x=intervalo_min,y=nivel_sonoro_avg)) +
#   geom_line()+
#   facet_wrap(punto~.)+
#   labs(x = "Intervalos de 15 minutos",
#        y = "SPL",
#        title = "SPL promedio cada 15 minutos para Navidad") +
#   theme_minimal()
# 
# figura_anio_nuevo_spl_avg   

```

